<!doctype html>
<html>

  <head>
    <meta charset=utf-8>
    <title>All Transforms</title>
    <style>
      body {
        padding: 0px 0px 0px 330px !important;
      }
      #theme_demo_menu a {
        display: block;
        color: black;
        font-size: 0.7em;
        font-weight: bold;
        padding: 3px 0px;
      }
      #theme_demo_menu {
        margin-top: 16px;
        padding-bottom: 32px;
      }
      #theme_demo_tools {
        background: #ccc;
        padding: 0px 15px;
        padding-top: 20px;
        position: fixed;
        left: 0px;
        top: 0px;
        width: 300px;
        overflow-y: scroll;
        height: 100%;
      }
      .theme_demo_article_title {
        color: red;
        font-size: 2.0em;
        padding-top: 15px;
      }
      iframe {        
        width: 100%;
        height: 100vh; /* initial value - gets reset */
        margin-top: 20px;
        border: 3px #ccc solid;
      }
      .checkbox_container {
        padding-top: 5px;
        padding-bottom: 5px;
      }
      .checkbox_label {
        margin-left:5px;
      }
      input[type=radio] {
        margin-left:15px;
      }
    </style>

    <script src='./DemoArticles/ArticleRef.js'></script>
    <script src='./DemoUtilities.js'></script>

  </head>

  <body>
    <div id='theme_demo_tools'>
      <form id='demo_controls'></form>
      <br>* = not currently reversible - reload page to reset
      <div id='theme_demo_menu'></div>
    </div>
    
    <script>

/* global ArticleRef, ArticleRefSourceType, flattenArrayOfArrays, pagelib */

/**
 * Converts article JSON to ArticleRefs.
 * @param {!Array<object>} json array of article JSON objects
 * @return {!Array<ArticleRef>}
 */
const articleRefsFromArticlesJSON = json => flattenArrayOfArrays(
  json.map(articleData => [
    new ArticleRef(
      articleData.lang,
      articleData.title,
      articleData.revision,
      ArticleRefSourceType.mobileView
    ),
    new ArticleRef(
      articleData.lang,
      articleData.title,
      articleData.revision,
      ArticleRefSourceType.mobileContentService
    )
  ])
)

/**
 * Converts ArticleRefs to anchor elements. 
 * @param {!Array<ArticleRef>} articleRefs
 * @return {!Array<HTMLAnchorElement>}
 */
const anchorsFromArticleRefs = articleRefs => articleRefs.map(articleRef => {
  const anchor = document.createElement('a')
  anchor.href = `#${articleRef.fileName()}`
  anchor.innerHTML = articleRef.displayName()
  return anchor
})

/**
 * Converts article JSON sections to HTML strings.
 * @param  {!Array<object>} sections
 * @return {!Array<String>}
 */
const enclosedSectionHTMLsFromSections = sections => sections.map(section => {
  const line = section.line || ''
  const toclevel = section.toclevel || '1'
  return `<div class='content_block' id='${section.id}'>
            <div class='section_header' id='${section.id}' line='${line}' toclevel='${toclevel}'>
              <h${toclevel}>${line}</h${toclevel}>
            </div>
            ${section.text}
          </div>`
})

/**
 * Converts section HTML strings to a single HTML string.
 * @param {!Array<string>} allSectionHTMLs
 * @return {!string}
 */
const htmlFromAllSectionHTMLs = allSectionHTMLs => allSectionHTMLs.join('')

const DEMO_ARTICLES_PATH = './DemoArticles/'
const DEMO_ARTICLES_INDEX_PATH = `${DEMO_ARTICLES_PATH}articles.json`
const DEMO_ARTICLES_DATA_PATH = `${DEMO_ARTICLES_PATH}data/`

/**
 * Promises for fetching article section JSON arrays from local data files for ArticleRefs.
 * @param {!Array<ArticleRef>} articleRefs
 * @return {!Array<Promise>}
 */
const fetchSectionsJSONForArticleRefs = articleRefs =>
  articleRefs.map(articleRef => articleRef.fetchSectionsJSON(DEMO_ARTICLES_DATA_PATH))

/**
 * Attaches anchor elements to the menu.
 * @param {!Array<HTMLAnchorElement>} anchors
 * @return {void}
 */
const addAnchorsToMenu = anchors => {
  const themeDemoMenu = document.getElementById('theme_demo_menu')
  anchors.forEach(anchor => themeDemoMenu.appendChild(anchor))
}




























const articleEnclosedInOuterHTML = articleHTML => {
  const script = 'script'
  return `
  <!doctype html>
  <html>
    <head>
      <meta charset=utf-8>
      <link href='https://en.wikipedia.org/w/load.php?debug=true&lang=en&modules=skins.minerva.base.reset|skins.minerva.content.styles|ext.cite.style|ext.math.styles|ext.timeline.styles|mediawiki.page.gallery.styles|mediawiki.skinning.content.parsoid&only=styles&version=&*' rel='stylesheet' type='text/css'></link>
      <link href=http://localhost:8080/wikimedia-page-library-transform.css rel=stylesheet>
      <style>
        body {
          padding: 20px !important;
        }
        .content_block {
          padding-bottom: 50px;
        }
      </style>
      <${script} src=http://localhost:8080/wikimedia-page-library-transform.js></${script}>
    </head>
    <body>
      <div class='content' id='content'>
      ${articleHTML}
      </div>
    </body>
    <${script}>
      pagelib.ThemeTransform.classifyElements(document)
    </${script}>
  </html>`
}

const expandIframeHeight = iframe => {
  iframe.style.height = `${iframe.contentWindow.document.body.offsetHeight}px`
}




const titleDivForArticleRef = articleRef => {
  const div = document.createElement('div')
  div.innerHTML = articleRef.displayName()
  div.classList.add('theme_demo_article_title')
  div.id = articleRef.fileName()
  div.title = articleRef.displayName()
  return div
}

const addHTMLToDocument = (html, articleRef) => {
  const iframe = document.createElement('iframe')
  iframe.scrolling = 'no'
  iframe.classList.add('article_preview')
  const titleDiv = titleDivForArticleRef(articleRef)
  document.body.appendChild(titleDiv)
  
  iframe.addEventListener('load', event => expandIframeHeight(event.target), true)
  
  document.body.appendChild(iframe)
  window.addEventListener('resize', () => expandIframeHeight(iframe), true)
  
  const iframeWindow = iframe.contentWindow
//  iframeWindow.pagelib = pagelib
  const iframeDocument = iframeWindow.document
  
  iframeDocument.open()
  iframeDocument.write(html)
  iframeDocument.close()
}




















const configureCheckboxClickToPerformClosureForEachIframe = (checkbox, closure) => {
  checkbox.addEventListener('click', event => {
    document.querySelectorAll('iframe.article_preview')
      .forEach(iframe => {
        closure(iframe.contentWindow, iframe.contentWindow.document, event, iframe)
        expandIframeHeight(iframe)
      })
  })
}


const addCheckboxToDemoControls = (id, title, type, value, iframeScopeClickClosure) => {  
  const checkboxContainer = document.createElement('div')
  checkboxContainer.classList.add('checkbox_container')
  
  const input = document.createElement('input')
  input.type = type
  input.name = id
  input.value = value
  checkboxContainer.appendChild(input)

  const label = document.createElement('label')
  label.for = id
  label.innerHTML = title
  label.classList.add('checkbox_label')  
  checkboxContainer.appendChild(label)

  document.getElementById('demo_controls').appendChild(checkboxContainer)

  configureCheckboxClickToPerformClosureForEachIframe(input, iframeScopeClickClosure)
}







const addTableCollapseControl = () => {
  addCheckboxToDemoControls('collapse_tables_checkbox', 'Collapse tables *', 'checkbox', null, (iframeWindow, iframeDocument) => {
      event.target.disabled = true
      iframeWindow.pagelib.CollapseTable.collapseTables(
        iframeWindow, iframeDocument, 'page title', false, 'Infobox', 'Information', 'Close', null
      )
  })
}

const addDimImagesControl = () => {
  addCheckboxToDemoControls('dim_images_checkbox', 'Dim images', 'checkbox', null, (iframeWindow, iframeDocument) => {
    iframeWindow.pagelib.DimImagesTransform.dim(
      iframeWindow,
      !iframeWindow.pagelib.DimImagesTransform.isDim(iframeWindow)
    )    
  })
}

const addEditPencilsControl = () => {
  addCheckboxToDemoControls('edit_pencil_checkbox', 'Edit pencils *', 'checkbox', null, (iframeWindow, iframeDocument) => {
    event.target.disabled = true
    const editPencilHeaderFromSectionHeader = sectionHeader =>
      iframeWindow.pagelib.EditTransform.newEditSectionHeader(
        iframeDocument, 
        sectionHeader.getAttribute('id'), 
        sectionHeader.getAttribute('toclevel'), 
        sectionHeader.getAttribute('line')
      )
    const replaceSectionHeaderWithEditPencilHeader = sectionHeader => {
      sectionHeader.parentNode.replaceChild(
        editPencilHeaderFromSectionHeader(sectionHeader),
        sectionHeader
      )      
    }
    iframeDocument.querySelectorAll('.section_header').forEach(replaceSectionHeaderWithEditPencilHeader)
  })
}

const addWidenImagesControl = () => {
  const shouldWidenImage = image => {
    return (image.getAttribute('width') && image.getAttribute('height') &&
    (parseInt(image.getAttribute('width'), 10) > 64) &&
    (parseInt(image.getAttribute('height'), 10) > 64)) //&&
    // image.getAttribute('data-file-width') && // MCS is not returning these??
    // image.getAttribute('data-file-height')
//TODO: file ticket for adding ^ to MCS and/or ensure this gets included on new endpoint!
//TODO: ask bearnd what ticket this new endpoint is on...
  }
  addCheckboxToDemoControls('widen_image_checkbox', 'Widen images *', 'checkbox', null, (iframeWindow, iframeDocument) => {
    event.target.disabled = true
    Array.from(iframeDocument.querySelectorAll('img'))
      .filter(shouldWidenImage)
      .forEach(img => iframeWindow.pagelib.WidenImage.maybeWidenImage(img))
  })
}

const addCompatibilityControl = () => {
  addCheckboxToDemoControls('compatibility_checkbox', 'Compatibility filter *', 'checkbox', null, (iframeWindow, iframeDocument) => {
    event.target.disabled = true
    iframeWindow.pagelib.CompatibilityTransform.enableSupport(iframeDocument)
  })
}

const addHideRedlinksControl = () => {
  addCheckboxToDemoControls('hide_redlinks_checkbox', 'Hide redlinks *', 'checkbox', null, (iframeWindow, iframeDocument) => {
    event.target.disabled = true
    iframeWindow.pagelib.RedLinks.hideRedLinks(iframeDocument)
  })
}

const addThemesControl = () => {
  const themeSelectionHandler = (iframeWindow, iframeDocument, event) => {
    iframeWindow.pagelib.ThemeTransform.classifyElements(iframeDocument)
    iframeWindow.pagelib.ThemeTransform.setTheme(iframeDocument, iframeWindow.pagelib.ThemeTransform.THEME[event.target.value])
  }
  const div = document.createElement('div')
  div.innerHTML = 'Theme'
  document.getElementById('demo_controls').appendChild(div)
  addCheckboxToDemoControls('theme_radio', 'Dark', 'radio', 'DARK', themeSelectionHandler)
  addCheckboxToDemoControls('theme_radio', 'Sepia', 'radio', 'SEPIA', themeSelectionHandler)
  addCheckboxToDemoControls('theme_radio', 'Default', 'radio', 'DEFAULT', themeSelectionHandler)
}

const addPlatformsControl = () => {
  const platformSelectionHandler = (iframeWindow, iframeDocument, event) => {
    const html = iframeDocument.querySelector('html')
    html.classList.remove(iframeWindow.pagelib.PlatformTransform.CLASS.ANDROID)
    html.classList.remove(iframeWindow.pagelib.PlatformTransform.CLASS.IOS)
    html.classList.add(iframeWindow.pagelib.PlatformTransform.CLASS[event.target.value])
  }
  const div = document.createElement('div')
  div.innerHTML = 'Platform'
  document.getElementById('demo_controls').appendChild(div)
  addCheckboxToDemoControls('platform_radio', 'iOS', 'radio', 'IOS', platformSelectionHandler)
  addCheckboxToDemoControls('platform_radio', 'Android', 'radio', 'ANDROID', platformSelectionHandler)

}

const addFooterContainer = (iframeWindow, iframeDocument) => {
  const containerFragment = iframeWindow.pagelib.FooterContainer.containerFragment(iframeDocument)
  iframeDocument.body.appendChild(containerFragment)
  iframeWindow.pagelib.FooterContainer.updateLeftAndRightMargin(16, iframeDocument)
}

const addFooterMenu = (iframeWindow, iframeDocument) => {
  iframeWindow.pagelib.FooterMenu.setHeading('About this article', 'pagelib_footer_container_menu_heading', iframeDocument)
  iframeWindow.pagelib.FooterMenu.maybeAddItem('Available in 10 other languages', '', iframeWindow.pagelib.FooterMenu.MenuItemType.languages, 'pagelib_footer_container_menu_items', ()=>{}, iframeDocument)
  iframeWindow.pagelib.FooterMenu.maybeAddItem('Edited 10 days ago', '', iframeWindow.pagelib.FooterMenu.MenuItemType.lastEdited, 'pagelib_footer_container_menu_items', ()=>{}, iframeDocument)
  iframeWindow.pagelib.FooterMenu.maybeAddItem('Page issues', '', iframeWindow.pagelib.FooterMenu.MenuItemType.pageIssues, 'pagelib_footer_container_menu_items', ()=>{}, iframeDocument)
  iframeWindow.pagelib.FooterMenu.maybeAddItem('Similar pages', '', iframeWindow.pagelib.FooterMenu.MenuItemType.disambiguation, 'pagelib_footer_container_menu_items', ()=>{}, iframeDocument)
  iframeWindow.pagelib.FooterMenu.maybeAddItem('View on a map', '', iframeWindow.pagelib.FooterMenu.MenuItemType.coordinate, 'pagelib_footer_container_menu_items', ()=>{}, iframeDocument)
}

const addFooterReadMore = (iframeWindow, iframeDocument, event, iframe) => {
  iframeWindow.pagelib.FooterReadMore.setHeading('Read more', 'pagelib_footer_container_readmore_heading', iframeDocument)
  const readMoreItemsFetchedHandler = titles => {
    let shouldSave = true
    titles.forEach(title => {
      iframeWindow.pagelib.FooterReadMore.updateSaveButtonForTitle(title, 'Saved for later', shouldSave, iframeDocument)
      shouldSave = !shouldSave
    })
    expandIframeHeight(iframe)
  }
  const baseURL = 'https://cors.io/?https://en.wikipedia.org'
  iframeWindow.pagelib.FooterReadMore.add('Ice_cream', 3, 'pagelib_footer_container_readmore_pages', baseURL, () => {}, readMoreItemsFetchedHandler, iframeDocument)
}

const addFooterLegal = (iframeWindow, iframeDocument) => {
  iframeWindow.pagelib.FooterLegal.add(iframeDocument, 'Content is available under $1 unless otherwise noted.', 'CC BY-SA 3.0', 'pagelib_footer_container_legal', ()=>{})
}

const addFooterControl = () => {
  addCheckboxToDemoControls('footer_checkbox', 'Add footer *', 'checkbox', null, (iframeWindow, iframeDocument, event, iframe) => {
    event.target.disabled = true
    addFooterContainer(iframeWindow, iframeDocument)
    addFooterMenu(iframeWindow, iframeDocument)
    addFooterReadMore(iframeWindow, iframeDocument, event, iframe)
    addFooterLegal(iframeWindow, iframeDocument)
  })
}

const addLazyImageLoadControl = () => {
    //TODO: add it!
}

const addTransformControls = () => {
  addThemesControl()
  addPlatformsControl()
  addTableCollapseControl()
  addDimImagesControl()
  addEditPencilsControl()
  addWidenImagesControl()
  addCompatibilityControl()
  addHideRedlinksControl()
  addFooterControl()
  //addLazyImageLoadControl()
}












  fetch(DEMO_ARTICLES_INDEX_PATH)
    .then(response => response.json())
    .then(articleRefsFromArticlesJSON)
    .then(articleRefs => Promise.all(fetchSectionsJSONForArticleRefs(articleRefs))
      .then(articlesSectionsJSON => articlesSectionsJSON.map(enclosedSectionHTMLsFromSections))
      .then(articlesEnclosedSectionHTML => articlesEnclosedSectionHTML.map(htmlFromAllSectionHTMLs))
      .then(articlesHTML => articlesHTML.map(articleEnclosedInOuterHTML))
      .then(articlesCompleteHTML => articlesCompleteHTML.map((articleCompleteHTML, i) => {
        return addHTMLToDocument(articleCompleteHTML, articleRefs[i])
      }))
      .then(() => anchorsFromArticleRefs(articleRefs))
      .then(addAnchorsToMenu)
      .then(addTransformControls)
  )






    </script>
</body>
</html>